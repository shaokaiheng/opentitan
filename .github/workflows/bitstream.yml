# Copyright lowRISC contributors (OpenTitan project).
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0

name: FPGA bitstream build
on:
  workflow_call:
    inputs:
      top_name:
        type: string
      design_suffix:
        type: string
      vivado_version:
        default: "2021.1"
        type: string

jobs:
  bitstream:
    name: Build bitstream
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required by get-bitstream-strategy.sh
      - name: Prepare environment
        uses: ./.github/actions/prepare-env
        with:
          service_account_json: '${{ secrets.BAZEL_CACHE_CREDS }}'

      - name: Extract cached bitstream
        run: |
          . util/build_consts.sh
          bazel_package="//hw/bitstream"
          design_name=chip_${{ inputs.top_name }}_${{ inputs.design_suffix }}
          cached_archive="${bazel_package}:${design_name}_cached_archive"
          ./bazelisk.sh build "${cached_archive}"
          bitstream_archive=$(./bazelisk.sh outquery "${cached_archive}")
          cp -Lv ${bitstream_archive} build-bin.tar

      - name: Upload step outputs
        uses: actions/upload-artifact@v4
        with:
          name: partial-build-bin-chip_${{ inputs.top_name }}_${{ inputs.design_suffix }}
          path: build-bin.tar

      - name: Upload artifacts if build failed
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: chip_${{ inputs.top_name }}_${{ inputs.design_suffix }}-build-out
          path: build-out
